apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "litellm.fullname" . }}-env-test"
  labels:
    {{- include "litellm.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  containers:
    - name: env-test
      image: busybox:latest
      command: ['sh', '-c']
      args:
        - |
          # Wait for service to be ready (up to 30 seconds)
          echo "Waiting for service to be ready..."
          for i in $(seq 1 30); do
            if wget -q -T 2 http://{{ include "litellm.fullname" . }}:{{ .Values.service.port }}/health/readiness; then
              break
            fi
            echo "Attempt $i: Service not ready, waiting..."
            sleep 1
          done

          # Test 1: Check if service is accessible
          echo "Test 1: Checking if service is accessible..."
          if ! wget -q -T 5 -O - http://{{ include "litellm.fullname" . }}:{{ .Values.service.port }}/health/readiness; then
            echo "Failed to connect to proxy"
            exit 1
          fi

          # Test 2: Verify specific environment variables through proxy config
          echo "Test 2: Verifying environment variables..."
          {{- range $key, $val := .Values.envVars }}
          echo "Checking {{ $key }}..."
          if wget -q -T 5 -O - http://{{ include "litellm.fullname" . }}:{{ .Values.service.port }}/health/readiness | grep -q "{{ $key }}"; then
            echo "✅ {{ $key }} is set"
          else
            echo "❌ {{ $key }} is not set"
            exit 1
          fi
          {{- end }}

          echo "All environment variable tests passed! ✨"
          exit 0
  restartPolicy: Never